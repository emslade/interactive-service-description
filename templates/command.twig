{% extends "layout.twig" %}

{% block content %}
<div class="command-title-container">
    <h1 class="command-title"><span class="muted">{{ method }}</span> {{ formattedUri|raw }}</h1>
    {% if related|length > 0 %}
    <p class="other-methods">Other method(s):</p>
    <ul class="related-methods">
        {% for httpMethod in ['GET', 'PUT', 'POST', 'DELETE'] %}
            <li>
            {% set item = related[httpMethod] %}
            {% if item %}
                <a {% if httpMethod == method %}class="related-method-{{ httpMethod }}"{% endif %} href="{{ item.link }}">{{ item.method }}</a>
            {% else %}
                <span class="unimplemented-method">{{ httpMethod }}</a>
            {% endif %}
            </li>
        {% endfor %}
    </ul>
    {% endif %}
</div>

<div class="command-container">
    <p class="command-summary">{{ summary }}</p>

    {% if params|length > 0 %}
    <h3>Parameters</h3>
    {% endif %}
    <form>
        <table class="params">
        {% for key, param in params %}
        <tr>
            <td class="param-key">
                <div>{{ key }}</div>
                <div class="muted">{{ param.required ? 'required' : 'optional' }}</div>
            </td>
            <td class="param-desc">
                <div>{{ param.description }}</div>
                <div class="muted">{{ param.type }}</div>
            </td>
            <td class="param-input">
                {% if param.enum %}
                <select name="{{ key }}" class="param">
                    <option></option>
                    {% for value in param.enum %}
                    <option>{{ value }}</option>
                    {% endfor %}
                </select>
                {% else %}
                <input name="{{ key }}" type="text" class="param">
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        </table>
        <div class="button-container">
            <button class="try-it">Try it!</button>
        </div>
    </form>

    <h3 class="request-title" hidden>Request</h3>
    <pre class="requestHeaders" hidden><code class="language-http"></code></pre>
    <pre class="request" hidden><code class="language-javascript"></code></pre>
    <h3 class="response-title" hidden>Response</h3>
    <pre class="responseHeaders" hidden><code class="language-http"></code></pre>
    <pre class="response" hidden><code class="language-javascript"></code></pre>
</div>

<script type="text/javascript">
$(function() {
    localStorage.clear();

    $('.try-it').click(function (e) {
        e.preventDefault();
        var data = {
            method: '{{ method }}',
            uri: '{{ uri }}',
            params: {}
        };

        $('.request-title').removeAttr('hidden');
        $('.requestHeaders').removeAttr('hidden');
        $('.request').removeAttr('hidden');
        $('.response-title').removeAttr('hidden');
        $('.responseHeaders').removeAttr('hidden');
        $('.response').removeAttr('hidden');

        $('.param').each(function (key, input) {
            if ($(input).val() !== '') {
                data.params[$(input).attr('name')] = $(input).val();
            }
        });

        replacer = function(match, param) {
            if (data.params.hasOwnProperty(param)) {
                val = data.params[param];
                delete data.params[param];
                return val;
            }
        };

        data.uri = data.uri.replace(/{([a-zA-Z]+)}/g, replacer);

        $.ajax({
            url: '/proxy.php',
            method: 'POST',
            contentType: 'application/json; charset=UTF-8',
            data: JSON.stringify(data)
        })
        .done(function (response) {
            $('.requestHeaders code').text(response.requestHeaders);
            if (typeof response.request !== 'undefined') {
                $('.request code').text(response.request);
            }
            $('.responseHeaders code').text(response.responseHeaders);
            $('.response code').text(response.response);
            Prism.highlightAll();
        });
    });
});
</script>
{% endblock %}
